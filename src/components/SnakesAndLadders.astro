---
const snakes: Record<number, number> = {
  16: 6,
  48: 30,
  62: 19,
  64: 60,
  79: 23,
  93: 68,
  95: 24,
  98: 78,
};

const ladders: Record<number, number> = {
  1: 38,
  4: 14,
  9: 31,
  21: 42,
  28: 84,
  36: 44,
  51: 67,
  71: 91,
  80: 100,
};

function buildBoard(): number[] {
  const rows: number[][] = [];
  let n = 100;

  for (let r = 0; r < 10; r++) {
    const row: number[] = [];
    for (let c = 0; c < 10; c++) {
      row.push(n--);
    }

    if (r % 2 === 1) row.reverse();
    rows.push(row);
  }

  return rows.flat();
}

const cells = buildBoard();
---

<aside class="rounded-xl border border-zinc-200 bg-white p-4 shadow-sm dark:border-zinc-800 dark:bg-zinc-900">
  <div class="flex items-start justify-between gap-3">
    <div class="min-w-0">
      <h2 class="text-[15px] font-semibold text-zinc-700 dark:text-zinc-50">Snakes &amp; Ladders</h2>
      <p class="mt-1 text-xs text-zinc-600 dark:text-zinc-400">
        Roll the dice and reach 100.
      </p>
      <div class="mt-2 flex flex-wrap items-center gap-x-3 gap-y-1 text-[11px] text-zinc-600 dark:text-zinc-400">
        <span class="inline-flex items-center gap-1">
          <span class="h-2.5 w-2.5 rounded-sm bg-rose-600"></span>
          <span>snake</span>
        </span>
        <span class="inline-flex items-center gap-1">
          <span class="h-2.5 w-2.5 rounded-sm bg-emerald-600"></span>
          <span>ladder</span>
        </span>
        <span class="inline-flex items-center gap-1">
          <span class="h-2.5 w-2.5 rounded-full bg-indigo-500"></span>
          <span>you</span>
        </span>
        <span class="inline-flex items-center gap-1">
          <span class="h-2.5 w-2.5 rounded-full bg-amber-500"></span>
          <span>computer</span>
        </span>
      </div>
    </div>
    <button
      type="button"
      data-sal-reset
      class="shrink-0 rounded-lg border border-zinc-200 px-2 py-1 text-xs text-zinc-700 hover:bg-zinc-50 dark:border-zinc-800 dark:text-zinc-200 dark:hover:bg-zinc-800"
    >
      Reset
    </button>
  </div>

  <div class="relative mt-4 grid grid-cols-10 gap-1" data-sal-board>
    {cells.map((n) => (
      <div
        class={`relative flex aspect-square items-center justify-center rounded-md border border-zinc-200 text-[10px] font-medium dark:border-zinc-800 ${
          snakes[n]
            ? 'bg-rose-600 text-white'
            : ladders[n]
              ? 'bg-emerald-600 text-white'
              : 'bg-white text-zinc-600 dark:bg-zinc-950 dark:text-zinc-400'
        }`}
        data-sal-cell={n}
      >
        <span class="absolute left-1 top-1 text-[9px] leading-none opacity-90">{n}</span>
        <span
          class="absolute bottom-1 left-1 h-2 w-2 rounded-full bg-indigo-500 opacity-0"
          data-sal-token="user"
        ></span>
        <span
          class="absolute bottom-1 right-1 h-2 w-2 rounded-full bg-amber-500 opacity-0"
          data-sal-token="computer"
        ></span>
      </div>
    ))}

    <div
      class="pointer-events-none absolute z-10 hidden max-w-[140px] -translate-x-1/2 translate-y-[calc(-100%-10px)] rounded-xl border border-white/40 bg-white/55 px-2 py-1 text-[9px] leading-snug text-zinc-900 shadow-lg backdrop-blur-md dark:border-zinc-800/60 dark:bg-zinc-900/45 dark:text-zinc-50"
      data-sal-bubble="user"
    >
      <div data-sal-bubble-text="user">You are here!</div>
      <div
        class="absolute left-1/2 top-full h-2 w-2 -translate-x-1/2 -translate-y-1 rotate-45 border-b border-r border-white/40 bg-white/55 dark:border-zinc-800/60 dark:bg-zinc-900/45"
        aria-hidden="true"
      ></div>
    </div>
    <div
      class="pointer-events-none absolute z-10 hidden max-w-[140px] -translate-x-1/2 translate-y-[calc(-100%-10px)] rounded-xl border border-white/40 bg-white/55 px-2 py-1 text-[9px] leading-snug text-zinc-900 shadow-lg backdrop-blur-md dark:border-zinc-800/60 dark:bg-zinc-900/45 dark:text-zinc-50"
      data-sal-bubble="computer"
    >
      <div data-sal-bubble-text="computer">Computer is here!</div>
      <div
        class="absolute left-1/2 top-full h-2 w-2 -translate-x-1/2 -translate-y-1 rotate-45 border-b border-r border-white/40 bg-white/55 dark:border-zinc-800/60 dark:bg-zinc-900/45"
        aria-hidden="true"
      ></div>
    </div>
  </div>

  <div class="mt-4 flex items-start justify-between gap-3">
    <div class="text-xs text-zinc-600 dark:text-zinc-400">
      <div>
        You:
        <span class="font-semibold text-zinc-700 dark:text-zinc-50" data-sal-user-pos>1</span>
      </div>
      <div>
        Computer:
        <span class="font-semibold text-zinc-700 dark:text-zinc-50" data-sal-computer-pos>1</span>
      </div>
      <div class="mt-1">
        Dice:
        <span class="font-semibold text-zinc-700 dark:text-zinc-50" data-sal-dice>â€“</span>
      </div>
    </div>

    <div class="flex flex-col items-end gap-2">
      <button
        type="button"
        data-sal-roll
        class="rounded-lg bg-zinc-900 px-3 py-2 text-xs font-semibold text-white hover:bg-zinc-800 disabled:cursor-not-allowed disabled:opacity-50 dark:bg-white dark:text-zinc-900 dark:hover:bg-zinc-200"
      >
        Roll
      </button>
      <div class="text-[11px] text-zinc-600 dark:text-zinc-400" data-sal-turn>Turn: You</div>
    </div>
  </div>

  <div class="mt-3 text-xs text-zinc-600 dark:text-zinc-400" data-sal-msg>
    Tip: ladders help, snakes hurt.
  </div>

  <div class="mt-3 text-xs text-zinc-600 dark:text-zinc-400">
    <div class="font-semibold text-zinc-700 dark:text-zinc-50">Last 2 moves</div>
    <div class="mt-1 space-y-1">
      <div data-sal-move-1>â€“</div>
      <div data-sal-move-2>â€“</div>
    </div>
  </div>

  <div class="mt-3 text-[15px] font-semibold text-zinc-700 dark:text-zinc-50" data-sal-result></div>
</aside>

<div class="pointer-events-none fixed inset-0 z-[60] hidden overflow-hidden" data-sal-confetti></div>

<style is:inline>
  @keyframes sal-confetti-fall {
    0% {
      transform: translate3d(var(--x, 0px), -20px, 0) rotate(0deg);
      opacity: 1;
    }
    100% {
      transform: translate3d(var(--x, 0px), 110vh, 0) rotate(720deg);
      opacity: 0;
    }
  }

  .sal-confetti {
    position: absolute;
    top: 0;
    left: 0;
    width: 10px;
    height: 10px;
    border-radius: 2px;
    animation: sal-confetti-fall 1600ms ease-in forwards;
  }
</style>

<script is:inline>
  (() => {
    const storageKey = 'sal_state_v1';
    const snakes = Object.freeze({
      16: 6,
      48: 30,
      62: 19,
      64: 60,
      79: 23,
      93: 68,
      95: 24,
      98: 78,
    });

    const ladders = Object.freeze({
      1: 38,
      4: 14,
      9: 31,
      21: 42,
      28: 84,
      36: 44,
      51: 67,
      71: 91,
      80: 100,
    });

    const root = document.currentScript && document.currentScript.parentElement;
    if (!root) return;

    const rollBtn = root.querySelector('[data-sal-roll]');
    const resetBtn = root.querySelector('[data-sal-reset]');
    const userPosEl = root.querySelector('[data-sal-user-pos]');
    const computerPosEl = root.querySelector('[data-sal-computer-pos]');
    const diceEl = root.querySelector('[data-sal-dice]');
    const msgEl = root.querySelector('[data-sal-msg]');
    const turnEl = root.querySelector('[data-sal-turn]');
    const move1El = root.querySelector('[data-sal-move-1]');
    const move2El = root.querySelector('[data-sal-move-2]');
    const resultEl = root.querySelector('[data-sal-result]');
    const boardEl = root.querySelector('[data-sal-board]');
    const userBubbleEl = root.querySelector('[data-sal-bubble="user"]');
    const computerBubbleEl = root.querySelector('[data-sal-bubble="computer"]');
    const userBubbleTextEl = root.querySelector('[data-sal-bubble-text="user"]');
    const computerBubbleTextEl = root.querySelector('[data-sal-bubble-text="computer"]');
    const confettiEl = document.querySelector('[data-sal-confetti]');

    const getCell = (n) => root.querySelector(`[data-sal-cell="${n}"]`);
    const getToken = (n, who) => {
      const cell = getCell(n);
      if (!cell) return null;
      return cell.querySelector(`[data-sal-token="${who}"]`);
    };

    const loseSound = () => {
      try {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx) return;
        const ctx = new AudioCtx();
        const gain = ctx.createGain();
        gain.gain.value = 0.07;
        gain.connect(ctx.destination);

        const playTone = (freq, t, dur) => {
          const osc = ctx.createOscillator();
          osc.type = 'sine';
          osc.frequency.value = freq;
          osc.connect(gain);
          osc.start(t);
          osc.stop(t + dur);
        };

        const t0 = ctx.currentTime + 0.02;
        playTone(392.0, t0, 0.16);
        playTone(329.63, t0 + 0.18, 0.18);
        playTone(261.63, t0 + 0.38, 0.28);
        setTimeout(() => ctx.close(), 1200);
      } catch {
        // ignore
      }
    };

    let userPos = 1;
    let computerPos = 1;
    let turn = 'user';
    let busy = false;
    let gameOver = false;
    let moves = ['â€“', 'â€“'];
    let userBubble = 'You are here!';
    let computerBubble = 'Computer is here!';
    let bubbleActive = 'user';
    let resultText = '';

    const readStored = () => {
      try {
        const raw = localStorage.getItem(storageKey);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch {
        return null;
      }
    };

    const writeStored = (state) => {
      try {
        localStorage.setItem(storageKey, JSON.stringify(state));
      } catch {
        // ignore
      }
    };

    const clearStored = () => {
      try {
        localStorage.removeItem(storageKey);
      } catch {
        // ignore
      }
    };

    const persist = () => {
      writeStored({
        userPos,
        computerPos,
        turn,
        busy,
        gameOver,
        moves,
        userBubble,
        computerBubble,
        bubbleActive,
        resultText,
      });
    };

    const placeBubble = (who) => {
      if (!boardEl) return;
      const bubbleEl = who === 'user' ? userBubbleEl : computerBubbleEl;
      if (!bubbleEl) return;

      const pos = who === 'user' ? userPos : computerPos;
      const cell = getCell(pos);
      if (!cell) {
        bubbleEl.classList.add('hidden');
        return;
      }

      const tokenEl = cell.querySelector(`[data-sal-token="${who}"]`);
      if (!(tokenEl instanceof HTMLElement)) {
        bubbleEl.classList.add('hidden');
        return;
      }

      const boardRect = boardEl.getBoundingClientRect();
      const tokenRect = tokenEl.getBoundingClientRect();
      const x = tokenRect.left - boardRect.left + tokenRect.width / 2;
      const y = tokenRect.top - boardRect.top;

      bubbleEl.style.left = `${x}px`;
      bubbleEl.style.top = `${y}px`;
    };

    const render = () => {
      root.querySelectorAll('[data-sal-token]').forEach((el) => el.classList.add('opacity-0'));

      const userToken = getToken(userPos, 'user');
      if (userToken) userToken.classList.remove('opacity-0');
      const computerToken = getToken(computerPos, 'computer');
      if (computerToken) computerToken.classList.remove('opacity-0');

      if (userPosEl) userPosEl.textContent = String(userPos);
      if (computerPosEl) computerPosEl.textContent = String(computerPos);
      if (turnEl) turnEl.textContent = `Turn: ${turn === 'user' ? 'You' : 'Computer'}`;
      if (move1El) move1El.textContent = moves[0] ?? 'â€“';
      if (move2El) move2El.textContent = moves[1] ?? 'â€“';
      if (rollBtn) rollBtn.disabled = busy || gameOver || turn !== 'user';
      if (resultEl) resultEl.textContent = resultText;

      if (userBubbleTextEl) userBubbleTextEl.textContent = userBubble;
      if (computerBubbleTextEl) computerBubbleTextEl.textContent = computerBubble;

      if (userBubbleEl) userBubbleEl.classList.toggle('hidden', bubbleActive !== 'user');
      if (computerBubbleEl)
        computerBubbleEl.classList.toggle('hidden', bubbleActive !== 'computer');

      placeBubble('user');
      placeBubble('computer');
    };

    const pushMove = (text) => {
      moves = [text, moves[0] ?? 'â€“'].slice(0, 2);
      render();
      persist();
    };

    const celebrate = () => {
      try {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (AudioCtx) {
          const ctx = new AudioCtx();
          const gain = ctx.createGain();
          gain.gain.value = 0.06;
          gain.connect(ctx.destination);

          const playTone = (freq, t, dur) => {
            const osc = ctx.createOscillator();
            osc.type = 'triangle';
            osc.frequency.value = freq;
            osc.connect(gain);
            osc.start(t);
            osc.stop(t + dur);
          };

          const t0 = ctx.currentTime + 0.02;
          playTone(523.25, t0, 0.12);
          playTone(659.25, t0 + 0.13, 0.12);
          playTone(783.99, t0 + 0.26, 0.18);
          setTimeout(() => ctx.close(), 1200);
        }
      } catch {
        // ignore
      }

      if (!confettiEl) return;
      confettiEl.classList.remove('hidden');
      confettiEl.innerHTML = '';

      const colors = ['#34d399', '#60a5fa', '#f472b6', '#fbbf24', '#a78bfa', '#fb7185'];
      const count = 80;

      for (let i = 0; i < count; i++) {
        const p = document.createElement('div');
        p.className = 'sal-confetti';
        const left = Math.random() * 100;
        const x = (Math.random() - 0.5) * 60;
        const delay = Math.random() * 180;
        const size = 6 + Math.random() * 8;
        p.style.left = `${left}vw`;
        p.style.background = colors[Math.floor(Math.random() * colors.length)];
        p.style.width = `${size}px`;
        p.style.height = `${size}px`;
        p.style.setProperty('--x', `${x}px`);
        p.style.animationDelay = `${delay}ms`;
        confettiEl.appendChild(p);
      }

      setTimeout(() => {
        confettiEl.classList.add('hidden');
        confettiEl.innerHTML = '';
      }, 2200);
    };

    const setMsg = (text) => {
      if (msgEl) msgEl.textContent = text;
    };

    const reset = () => {
      userPos = 1;
      computerPos = 1;
      turn = 'user';
      busy = false;
      gameOver = false;
      moves = ['â€“', 'â€“'];
      userBubble = 'You are here!';
      computerBubble = 'Computer is here!';
      bubbleActive = 'user';
      resultText = '';
      if (diceEl) diceEl.textContent = 'â€“';
      setMsg('Tip: ladders help, snakes hurt.');
      render();
      clearStored();
    };

    const step = (fromPos, dice) => {
      let next = fromPos + dice;
      if (next > 100) next = 100;
      const jumpedTo = ladders[next] ?? snakes[next];
      return { next, final: jumpedTo ?? next, jumpedTo };
    };

    const describeJump = (next, jumpedTo) => {
      if (!jumpedTo) return '';
      if (ladders[next]) return `ladder ${next}â†’${jumpedTo}`;
      if (snakes[next]) return `snake ${next}â†’${jumpedTo}`;
      return `${next}â†’${jumpedTo}`;
    };

    const computerMove = (instant = false) => {
      if (gameOver) return;
      bubbleActive = 'computer';
      const dice2 = Math.floor(Math.random() * 6) + 1;
      if (diceEl) diceEl.textContent = String(dice2);

      const { next: next2, final: final2, jumpedTo: jumpedTo2 } = step(computerPos, dice2);
      const before = computerPos;
      computerPos = final2;

      const jumpText = describeJump(next2, jumpedTo2);
      computerBubble = jumpText
        ? `Computer moved ${dice2} ( ${jumpText} )`
        : `Computer walked ${dice2} steps`;
      pushMove(
        jumpText
          ? `Computer rolled ${dice2}: ${before} â†’ ${final2} (${jumpText})`
          : `Computer rolled ${dice2}: ${before} â†’ ${final2}`
      );

      if (computerPos === 100) {
        gameOver = true;
        resultText = 'Computer won ðŸŽ‰';
        loseSound();
        busy = false;
        turn = 'computer';
        render();
        persist();
        return;
      }

      turn = 'user';
      busy = false;
      userBubble = 'You are here!';
      bubbleActive = 'user';
      render();
      persist();

      if (instant) return;
    };

    const roll = () => {
      if (busy || gameOver) return;
      if (turn !== 'user') return;

      bubbleActive = 'user';

      const dice = Math.floor(Math.random() * 6) + 1;
      if (diceEl) diceEl.textContent = String(dice);

      const { next, final, jumpedTo } = step(userPos, dice);
      const before = userPos;
      userPos = final;

      const jumpText = describeJump(next, jumpedTo);
      userBubble = jumpText ? `You moved ${dice} ( ${jumpText} )` : `You walked ${dice} steps`;
      pushMove(
        jumpText ? `You rolled ${dice}: ${before} â†’ ${final} (${jumpText})` : `You rolled ${dice}: ${before} â†’ ${final}`
      );

      setMsg('');

      if (userPos === 100) {
        gameOver = true;
        resultText = 'You won ðŸŽ‰';
        render();
        persist();
        celebrate();
        return;
      }

      turn = 'computer';
      busy = true;
      render();
      persist();

      setTimeout(() => {
        computerMove(true);
      }, 800);
    };

    const stored = readStored();
    if (stored) {
      if (typeof stored.userPos === 'number') userPos = stored.userPos;
      if (typeof stored.computerPos === 'number') computerPos = stored.computerPos;
      if (stored.turn === 'user' || stored.turn === 'computer') turn = stored.turn;
      if (typeof stored.busy === 'boolean') busy = stored.busy;
      if (typeof stored.gameOver === 'boolean') gameOver = stored.gameOver;
      if (Array.isArray(stored.moves)) moves = stored.moves.slice(0, 2);
      if (typeof stored.userBubble === 'string') userBubble = stored.userBubble;
      if (typeof stored.computerBubble === 'string') computerBubble = stored.computerBubble;
      if (stored.bubbleActive === 'user' || stored.bubbleActive === 'computer') {
        bubbleActive = stored.bubbleActive;
      }
    }

    render();
    persist();

    if (busy && turn === 'computer' && !gameOver) {
      setTimeout(() => {
        computerMove(true);
      }, 0);
    }

    rollBtn && rollBtn.addEventListener('click', roll);
    resetBtn && resetBtn.addEventListener('click', reset);
  })();
</script>
